# セグメント抽出実験結果サマリー

## 概要

IMU歩行データからLSTM学習用の直線歩行セグメントを抽出する方法を検討しました。
複数の手法を比較した結果、**閾値ベース + 前処理** が最も効果的であることが判明しました。

## 実験した手法

### 1. 閾値ベース（Threshold-based）
- 進行方向の変化率（heading change rate）が閾値以下の区間を直線と判定
- シンプルで安定した結果

### 2. スパイク検出（Spike-based）
- heading change rateのピーク（スパイク）を検出してターン区間を特定
- 相対的な変化を検出するため、ドリフトの影響を受けにくいことを期待
- パラメータチューニングが困難

### 3. 前処理の有無
- **前処理あり**: Smooth PCA + Y軸ドリフト除去
- **前処理なし**: 生データをそのまま使用

## 比較結果

### 総セグメント数（30被験者合計）

| 手法 | セグメント数 | 最良だった被験者数 |
|------|-------------|------------------|
| **閾値 + 前処理** | **1,081** | **27 / 30** |
| 閾値 + 生データ | 820 | 6 / 30 |
| スパイクv1 + 前処理 | 1,029 | 1 / 30 |
| スパイクv2 + 生データ | 309 | 2 / 30 |
| スパイクv2 + 前処理 | 149 | 0 / 30 |

### 結論

1. **前処理は効果的**: ドリフト補正により、より多くの直線セグメントを検出可能
2. **閾値ベースが最も安定**: パラメータが直感的で調整しやすい
3. **スパイク検出は期待通りの効果なし**: パラメータチューニングが困難で、安定した結果が得にくい

## 推奨パラメータ

### 前処理パラメータ
```python
drift_correction_strength = 'moderate'  # minimal / moderate / aggressive
```

### セグメント抽出パラメータ（閾値ベース + 前処理）
```python
SegmentExtractionParams(
    velocity_threshold=0.4,           # m/s - 歩行判定の速度閾値
    heading_change_threshold=0.1,     # rad/frame (~5.7°) - 直線判定の方向変化閾値
    trim_start_seconds=0.5,           # 開始時のトリミング
    trim_end_seconds=0.3,             # 終了時のトリミング
    min_segment_seconds=2.0,          # 最小セグメント時間
    min_segment_meters=5.0,           # 最小セグメント距離
    use_overlapping_windows=True,     # オーバーラップウィンドウ使用
    window_seconds=5.0,               # LSTMウィンドウサイズ
    window_overlap=0.5,               # 50%オーバーラップ
    frame_rate=60                     # フレームレート
)
```

## 処理フロー図

```
┌─────────────────────────────────────────────────────────────────┐
│                    IMU生データ (Excel)                           │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 1: 前処理 (Feature Preserving Correction)                  │
│  ├─ Global PCA回転（主方向をX軸に整列）                            │
│  ├─ Y軸ドリフト除去（ハイパスフィルタ、歩行リズム保存）                │
│  └─ Body-centered座標変換                                        │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 2: 直線区間検出                                             │
│  ├─ 速度計算: velocity = d(position)/dt                          │
│  ├─ 歩行判定: velocity > 0.4 m/s                                 │
│  ├─ 方向変化計算: heading_rate = d(heading)/dt                    │
│  └─ 直線判定: heading_rate < 0.1 rad/frame                       │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 3: セグメント抽出                                           │
│  ├─ 連続した直線区間を検出                                         │
│  ├─ 開始/終了のトリミング（加速/減速区間除去）                        │
│  ├─ 最小時間・距離でフィルタリング                                  │
│  └─ オーバーラップウィンドウ生成                                    │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  出力: List[ExtractedSegment]                                    │
│  ├─ data: (n_frames, n_joints, 3) 位置データ                      │
│  ├─ start_frame, end_frame: フレーム範囲                          │
│  ├─ duration_sec: 継続時間                                       │
│  └─ distance_m: 移動距離                                         │
└─────────────────────────────────────────────────────────────────┘
```

## 被験者別結果（閾値 + 前処理）

| 被験者 | セグメント数 | 備考 |
|--------|-------------|------|
| NCC01-001 | 39 | |
| NCC03-001 | 34 | |
| NCC04-002 | 39 | 生データの方が良い（80セグメント）|
| NCC05-002 | 26 | |
| NCC06-001 | 27 | |
| NCC07-002 | 46 | |
| NCC08-003 | 32 | |
| NCC10-001 | 47 | |
| NCC11-001 | 32 | |
| NCC12-001 | 42 | |
| NCC13-002 | 46 | |
| NCC14-001 | 44 | |
| NCC15-002 | 27 | |
| NCC16-001 | 29 | |
| NCC17-001 | 21 | |
| NCC18-001 | 33 | |
| NCC19-002 | 32 | |
| NCC20-001 | 25 | |
| NCC21-002 | 45 | |
| NCC22-002 | 33 | |
| NCC23-001 | 27 | |
| NCC24-001 | 25 | |
| NCC25-001 | 43 | 前処理で大幅改善（生データ: 2）|
| NCC26-002 | 52 | 前処理で大幅改善（生データ: 2）|
| NCC27-001 | 56 | |
| NCC28-001 | 31 | |
| NCC29-001 | 43 | 前処理で大幅改善（生データ: 0）|
| NCC30-002 | 29 | |
| NCC31-001 | 45 | |
| NCC32-002 | 31 | 前処理で大幅改善（生データ: 3）|
| **合計** | **1,081** | |

## 今後の改善点

1. **適応型パラメータ**: データの特性に応じて自動的にパラメータを調整
2. **品質指標の追加**: 抽出されたセグメントの品質を評価する指標
3. **異常検出**: 明らかに異常なセグメントを自動除外

## ファイル構成

```
scripts/gait_analysis/
├── feature_preserving_correction.py  # 前処理
├── improved_segment_extraction.py    # 閾値ベースセグメント抽出（推奨）
├── spike_based_segment_extraction.py # スパイク検出v1（参考）
└── spike_based_segment_extraction_v2.py # スパイク検出v2（参考）
```
